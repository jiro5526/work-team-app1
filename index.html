<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>作業人員記録アプリ（○△×・共有対応）</title>
<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2; --card:#fff; --soft:#f5f6fb; --line:#ddd; --brand:#667eea;
  }
  body{font-family:'Hiragino Kaku Gothic ProN','Yu Gothic',sans-serif;
    background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);min-height:100vh;padding:20px;}
  .container{max-width:640px;margin:0 auto;background:var(--card);border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);padding:28px;}
  h1{text-align:center;color:var(--brand);margin:0 0 24px;font-size:26px;}
  .form-group{margin-bottom:16px;}
  label{display:block;margin-bottom:8px;font-weight:700;color:#444;}
  input[type="date"],select{
    width:100%;padding:10px 12px;border:2px solid var(--line);border-radius:10px;font-size:16px;background:#fff;
  }
  .row{display:flex;gap:12px;align-items:center}
  .row > *{flex:1}
  .btn{width:100%;padding:12px;border:none;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;margin-top:10px;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));}
  .result-area{margin-top:24px;background:var(--soft);border-radius:12px;padding:16px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;background:#fff;border-radius:8px;overflow:hidden}
  th,td{border:1px solid #ccc;padding:8px;text-align:center}
  th{background:#e9edff}
  .totals-row{font-weight:700;background:#eef2ff}
</style>
</head>
<body>
  <div class="container">
    <h1>作業人員記録アプリ（○△×対応）</h1>

    <form id="workForm">
      <div class="form-group">
        <label for="workDate">作業日 *</label>
        <input type="date" id="workDate" required>
      </div>

      <div class="form-group row">
        <div>
          <label>時長</label>
          <select id="jicho">
            <option value="">選択</option><option value="○">○</option><option value="△">△</option><option value="×">×</option>
          </select>
        </div>
        <div>
          <label>鈴村</label>
          <select id="suzumura">
            <option value="">選択</option><option value="○">○</option><option value="△">△</option><option value="×">×</option>
          </select>
        </div>
        <div>
          <label>丸山</label>
          <select id="maruyama">
            <option value="">選択</option><option value="○">○</option><option value="△">△</option><option value="×">×</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn">記録する</button>
    </form>

    <button id="showResultBtn" class="btn">結果表示</button>
    <button id="downloadCsvBtn" class="btn">スプレッドシート出力</button>

    <div id="resultArea" class="result-area" style="display:none;"></div>
  </div>

<script>
class MyApp {
  constructor(){
    this.API_URL = 'https://script.google.com/macros/s/AKfycbw3yTeNBdcqUtSrbxNbeEUFf2n_FxBmUEc1JBesX9IQfP-k6a6DleZ88D8sFswwbJTA/exec';
    this.API_KEY = 'mySecretKey123';

    this.records = [];
    this.tableBody = document.querySelector('#dataTable tbody');
    this.inputDate = document.getElementById('inputDate');
    this.inputName = document.getElementById('inputName');
    this.inputAmount = document.getElementById('inputAmount');

    document.getElementById('btnAdd').addEventListener('click', () => this.addOrUpdateRecord());
    document.getElementById('btnSync').addEventListener('click', () => this.syncFromServer());

    this.syncFromServer();
  }

  // 日付を統一して YYYY-MM-DD に変換
  normalizeDate(s){
    if (!s) return '';
    // すでに YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // YYYY/MM/DD → YYYY-MM-DD
    if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) {
      const [y,m,d] = s.split('/');
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    // Date文字列を解釈
    const d = new Date(s);
    if (!isNaN(d)) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    return s; // 不明形式はそのまま
  }

  // 曜日付き表示
  formatYobi(yyyyMmDd){
    const norm = this.normalizeDate(yyyyMmDd);
    const [y,m,d] = norm.split('-').map(Number);
    if(!y||!m||!d) return yyyyMmDd || '';
    const dt = new Date(y, m-1, d);
    const w = '日月火水木金土'[dt.getDay()];
    return `${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')} (${w})`;
  }

  async fetchAll(){
    const res = await fetch(`${this.API_URL}?key=${this.API_KEY}`);
    if(!res.ok) throw new Error('HTTPエラー');
    return await res.json();
  }

  async pushAll(data){
    const res = await fetch(this.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: this.API_KEY, records: data })
    });
    if(!res.ok) throw new Error('HTTPエラー');
    return await res.json();
  }

  async syncFromServer(){
    try{
      const fetched = await this.fetchAll();
      const normalized = fetched.map(r => ({ ...r, date: this.normalizeDate(r.date) }));

      // サーバの日付が変わっていたら書き戻す
      const changed =
        JSON.stringify(fetched.map(r=>r.date)) !== JSON.stringify(normalized.map(r=>r.date));
      if (changed) {
        await this.pushAll(normalized);
      }
      this.records = normalized;
      this.render();
    }catch(e){
      alert('サーバから読み込みに失敗しました。\n' + e.message);
    }
  }

  async addOrUpdateRecord(){
    const date = this.normalizeDate(this.inputDate.value);
    const name = this.inputName.value.trim();
    const amount = this.inputAmount.value.trim();
    if(!date || !name || !amount) return alert('全て入力してください');

    const existingIndex = this.records.findIndex(r => r.date === date && r.name === name);
    if(existingIndex >= 0){
      this.records[existingIndex].amount = amount;
    }else{
      this.records.push({ date, name, amount });
    }

    try{
      await this.pushAll(this.records);
      this.render();
      this.inputDate.value = '';
      this.inputName.value = '';
      this.inputAmount.value = '';
    }catch(e){
      alert('保存に失敗しました\n' + e.message);
    }
  }

  render(){
    this.tableBody.innerHTML = '';
    this.records.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${this.formatYobi(r.date)}</td>
        <td>${r.name}</td>
        <td>${r.amount}</td>
      `;
      this.tableBody.appendChild(tr);
    });
  }
}

document.addEventListener('DOMContentLoaded', () => new MyApp());
</script>

</body>
</html>
